<html>

<script src="../../../ioBroker.admin/admin.js"></script>
<link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.min.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/css/jqGrid/ui.jqgrid-4.5.4.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/css/jquery.multiselect-1.13.css"/>
<script type="text/javascript" src="../../lib/js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="../../socket.io/socket.io.js"></script>
<script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>
<script type="text/javascript" src="../../lib/js/jqGrid/jquery.jqGrid-4.5.4.min.js"></script>
<script type="text/javascript" src="../../lib/js/jqGrid/grid.locale-all.js"></script>

<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
<script type="text/javascript" src="../../js/translate.js"></script>
<script type="text/javascript" src="../../js/adapter-settings.js"></script>
<script type="text/javascript" src="parse.js"></script>

<style>
    .oneWidth {
        width: 120px;
    }

    @keyframes highlight {
        0% {
            color: #00f900
        }
        80% {
            color: green
        }
        100% {
            color: black;
        }
    }
    .pair-on {
        background: rgb(255, 153, 153) !important;
    }
    .error {
        color: rgb(255, 15, 15);
    }
    #devices tr:nth-child(even) {
        background: lightgray;
    }
    .highlight {
        animation: highlight 2s;
    }


</style>
<script type="text/javascript">
    // Dictionary (systemDictionary is global variable from adapter-settings.js)
    systemDictionary = {
        "rflink adapter settings": {"ru": "Настройки"},
        "Select port":          {"en": "Select port",   "de": "Select port",            "ru": "COM порт"},
        "Bind":                 {"en": "Bind",          "de": "Bind",                   "ru": "IP сервера:"},
        "RFLink adapter settings": {
            "en": "RFLink adapter settings",
            "de": "RFLink Einstellungen",
            "ru": "Настройки RFLink драйвера"
        },
        "serial":               {"en": "serial",            "de": "serial",             "ru": "COM порт"},
        "Not available":        {"en": "Not available",     "de": "Nicht möglich",      "ru": "недоступно"},
        "Com port:":            {"en": "Com port:",         "de": "Serialport:",        "ru": "Имя порта:"},
        "Baud rate:":           {"en": "Baud rate:",        "de": "Baudrate:",          "ru": "Скорость порта:"},
        "Connection timeout:":  {"en": "Connection timeout:", "de": "Verbindungs-Timeout:", "ru": "Таймаут соединения:"},
        "ms":                   {"en": "ms",                "de": "ms",                 "ru": "мс"},
        "inclusion help":       {
            "en": "ms (Set to 0 for manually control)",
            "de": "ms (Setzte auf 0 um manuell zu steuern)",
            "ru": "мс (Установите в ноль для ручного вкл./выключения"
        },
        "Inclusion mode timeout:": {"en": "Inclusion mode timeout:", "de": "Anlernen-Timeout:", "ru": "Время для присваивания адресов:"},
        "Enable inclusion mode": {"en": "Enable inclusion mode", "de": "Anlernen-Modus aktivieren", "ru": "Включить режим присваивания адресов"},
        "Disable inclusion mode": {"en": "Disable inclusion mode", "de": "Anlernen-Modus deaktivieren", "ru": "Выключить режим присваивания адресов"},
        "Inclusion mode is active": {
            "en": "Inclusion mode is active",
            "de": "Anlernen-Modus ist aktiv",
            "ru": "Режим присваивания адресов активирован"
        },
        "Ok":                   {"en": "Ok",                "de": "Ok",                 "ru": "Ok"},
        "Options":              {"en": "Options",           "de": "Einstellungen",      "ru": "Настройки"},
        "Devices":              {"en": "Devices",           "de": "Geräte",             "ru": "Устройства"},
        "Timeout for auto re-pair:": {
            "en": "Timeout for auto re-pair:",
            "de": "Timeout füt Auto-Wieder-Verbindung:",
            "ru": "Таймаут для авто связывания:"
        },
        "re-pair help": {
            "en": "minutes",
            "de": "Minuten",
            "ru": "в минутах"
        },
        "Brand":                {"en": "Brand",             "de": "Firma",              "ru": "Фирма"},
        "Number":               {"en": "Number",            "de": "Nummer",             "ru": "Номер"},
        "Auto re-pair":         {"en": "Auto re-pair",      "de": "Auto re-pair",       "ru": "Авто re-pair"},
        "Values":               {"en": "Values",            "de": "Werte",              "ru": "Значения"},
        "Pair":                 {"en": "Pair",              "de": "Verbinden",          "ru": "Связать"},
        "Are you sure?":        {"en": "Are you sure?",     "de": "Sind Sie sicher?",   "ru": "Вы уверенны?"}
    };

    var timeout;
    var channels = {};

    function getComPorts(actualValue) {
        timeout = setTimeout(function () {
            getComPorts(actualValue);
        }, 2000);

        sendTo(null, 'listUart', null, function (list) {
            if (timeout) {
                clearTimeout(timeout);
                timeout = null;
            }
            if (!list || !list.length) {
                setTimeout(function () {
                    getComPorts(actualValue);
                }, 1000);
                return;
            }
            var text = '<option value="">' + _('Select port') + '</option>';
            for (var j = 0; j < list.length; j++) {
                if (list[j].comName === 'Not available') {
                    text += '<option value="" selected>' + _('Not available') + '</option>';
                    $('#comName').prop('disabled', true);
                    break;
                } else {
                    text += '<option value="' + list[j].comName + '" ' + ((actualValue === list[j].comName) ? 'selected' : '') + '>' + list[j].comName + '</option>';
                }
            }
            $('#comName').html(text);
        });
    }

    function setValue(id, value, onChange) {
        if ($('#' + id + '.value').attr('type') === 'checkbox') {
            $('#' + id + '.value').prop('checked', value).change(function () {
                onChange();
            });
        } else {
            $('#' + id + '.value').val(value).change(function () {
                onChange();
            }).keyup(function () {
                // Check that only numbers entered
                if ($(this).hasClass('number')) {
                    var val = $(this).val();
                    if (val) {
                        var newVal = '';
                        for (var i = 0; i < val.length; i++) {
                            if (val[i] >= '0' && val[i] <= '9') {
                                newVal += val[i];
                            }
                        }
                        if (val != newVal) $(this).val(newVal);
                    }
                }
                onChange();
            });
        }
    }

    function deleteState(id) {
        socket.emit('delObject', id, function (err) {
            socket.emit('delState', id, function (err) {

            });
        });
    }

    function showDevice(obj) {
        if (obj._id === 'rflink.' + instance + '.info') return;
        var text = '';
        text += '<td style="text-align: right; white-space: nowrap;"' +
                ((obj.native.ID === null || obj.native.ID === undefined || obj.native.ID === '') ? 'class="error" title="' + _('No address') + '"' : '') + '>'  + obj.native.brand  + '</td>';
        text += '<td style="text-align: center;">' + obj.native.index + '</td>';
        text += '<td style="text-align: center;"><input class="auto-repair" type="input" data-id="' + obj._id + '" value="' + (obj.native.autoRepair || 0) + '" /></td>';
//        if (obj.native.offset !== undefined) {
//            text += '<td style="text-align: center;"><input class="offset" type="input" data-id="' + obj._id + '" value="' + (obj.native.offset || 0) + '" /></td>';
//        } else {
//            text += '<td></td>';
//        }
//        if (obj.native.factor !== undefined) {
//            text += '<td style="text-align: center;"><input class="factor" type="input" data-id="' + obj._id + '" value="' + (obj.native.factor || 1) + '" /></td>';
//        } else {
//            text += '<td></td>';
//        }
        //text += '<td style="text-align: right;">'  + obj.native.ID    + '</td>';
        text += '<td style="text-align: left;"   class="raw-value"   data-id="' + obj._id + '"></td>';
        text += '<td style="text-align: center"><button class="pair" data-id="' + obj._id + '"></button></td>';
        text += '<td style="text-align: center"><button class="del"  data-id="' + obj._id + '"></button></td>';

        if (channels[obj._id]) {
            $('tr[data-channel="' + obj._id + '"]').html(text);
        } else {
            text = '<tr class="device" data-channel="' + obj._id + '">' + text + '</tr>';
            $('#devices').append(text);
        }

        channels[obj._id] = obj;

        $('.del[data-id="' + obj._id + '"]').button({
            text: false,
            icons: {
                primary: 'ui-icon-trash'
            }
        }).css({width: 22, height: 22}).unbind('click').click(function () {
            var id = $(this).data('id');
            if (confirm(_('Are you sure?'))) {
                socket.emit('delObject', id, function () {
                    socket.emit('getObjectView', 'system', 'state', {startkey: id + '.', endkey: id + '.\u9999', include_docs: true}, function (err, res) {
                        for (var i = 0; i < res.rows.length; i++) {
                            deleteState(res.rows[i].id);
                        }
                        $('tr[data-channel="' + id + '"]').remove();
                        delete channels[id];
                    });
                });
            }
        });

        $('.auto-repair[data-id="' + obj._id + '"]').change(function () {
            var $this = $(this);
            var id = $this.data('id');
            $this.prop('disabled', true);
            channels[id].native.autoRepair != channels[id].native.autoRepair;
            socket.emit('setObject', id, channels[id], function (err) {
                // button will be re-drawn on change
            });
        });

        $('.offset[data-id="' + obj._id + '"]').change(function () {
            var $this = $(this);
            var id = $this.data('id');
            $this.prop('disabled', true);
            channels[id].native.offset = parseFloat($this.val());
            socket.emit('setObject', id, channels[id], function (err) {
                // button will be re-drawn on change
            });
        });
        $('.factor[data-id="' + obj._id + '"]').change(function () {
            var $this = $(this);
            var id = $this.data('id');
            $this.prop('disabled', true);
            channels[id].native.factor = parseFloat($this.val());
            socket.emit('setObject', id, channels[id], function (err) {
                // button will be re-drawn on change
            });
        });

        var $pair = $('.pair[data-id="' + obj._id + '"]');
        $pair.button({
            text: false,
            icons: {
                primary: 'ui-icon-transfer-e-w'
            }
        }).css({width: 22, height: 22}).unbind('click').click(function () {
            var $this = $(this);
            var id = $this.data('id');
            $this.button('disable');

            if (!channels[id].native.pair) {
                channels[id].native.pair = true;
                channels[id].native.ID   = null; // Reset ID
            } else {
                channels[id].native.pair = false;
            }

            socket.emit('setObject', id, channels[id], function (err) {
                // button will be re-drawn on change
            });
        });

        if (obj.native.pair) {
            $pair.addClass('pair-on');
        }
    }

    function load(settings, onChange) {
        if (!settings) return;
        for (var key in settings) {
            setValue(key, settings[key], onChange);
        }

        $('#enableInclusion').button().hide();

        $('#tabs').show().tabs();

        setTimeout(function () {
            socket.emit('getState', adapter + '.' + instance + '.inclusionOn', function (err, state) {
                if (err) window.alert(err);

                $('#enableInclusion').button('option', 'label', state && state.val ? _('Disable inclusion mode') : _('Enable inclusion mode')).show().click(function () {
                    socket.emit('getState', adapter + '.' + instance + '.inclusionOn', function (err, state) {
                        state     = state || {val: false};
                        state.val = !state.val;

                        $('#enableInclusion').button('option', 'label', state && state.val ? _('Disable inclusion mode') : _('Enable inclusion mode'));

                        socket.emit('setState', adapter + '.' + instance + '.inclusionOn', {
                            val: state.val,
                            ack: false
                        }, function (err) {
                            if (!err) {
                                showMessage(_('Inclusion mode is active'));
                            } else {
                                showError(err);
                            }
                        });
                    });
                });
            });
        }, 1000);

        getIsAdapterAlive(function (isAlive) {
            if (isAlive || common.enabled) {
                getComPorts(settings.comName);
            } else {
                $('#getUnit').prop('disabled', true);
            }
        });

        socket.emit('getObjectView', 'system', 'channel', {startkey: 'rflink.' + instance + '.', endkey: 'rflink.' + instance + '.\u9999', include_docs: true}, function (err, res) {
            res.rows.sort(function (a, b) {
                if (a.value.native.brand > b.value.native.brand) return 1;
                if (a.value.native.brand < b.value.native.brand) return -1;
                return 0;
            });

            for (var i = 0; i < res.rows.length; i++) {
                showDevice(res.rows[i].value);
            }
        });

        socket.on('objectChange', function (id, obj) {
            if (!obj) {
                $('tr[data-channel="' + id + '"]').remove();
            } else {
                if (obj.type === 'channel' && id !== 'rflink.' + instance + '.info' && obj.native && obj.native.brand) showDevice(obj);
            }
        });

        socket.on('stateChange', function (id, state) {
            if (id === 'rflink.' + instance + '.inclusionOn') {
                $('#enableInclusion').button('option', 'label', state && state.val ? _('Disable inclusion mode') : _('Enable inclusion mode'));
            } else {
                // analyse rawData
                if (!state || !state.val || !state.ack || typeof state.val !== 'string') return;

                // received something like:
                // UPM/Esic;ID=0001;TEMP=00cf;HUM=16;BAT=OK;
                var frame = parseString(state.val);
                if (!frame) return;
                var _id;

                for (_id in channels) {
                    if (!channels.hasOwnProperty(_id) || !channels[_id].native) continue;

                    if (channels[_id].native.brand === frame.brandRaw &&
                        channels[_id].native.ID === frame.ID &&
                        (frame.SWITCH === undefined || (channels[_id].native.switches && channels[_id].native.switches.indexOf(frame.SWITCH) !== -1))
                    ) {
                        delete frame.ID;
                        delete frame.brand;
                        delete frame.brandRaw;

                        $('.raw-value[data-id="' + _id + '"]').html('<span class="highlight">' + stringifyFrame(frame) + '</span>');
                        return;
                    }
                }
            }
        });

        socket.emit('subscribeObjects', 'rflink.' + instance + '.*');
        socket.emit('subscribeStates',  'rflink.' + instance + '.rawData');
        socket.emit('subscribeStates',  'rflink.' + instance + '.inclusionOn');
        onChange(false);
    }

    function save(callback) {
        var obj = {};
        $('.value').each(function () {
            var $this = $(this);
            if ($this.attr('type') === 'checkbox') {
                obj[$this.attr('id')] = $this.prop('checked');
            } else {
                obj[$this.attr('id')] = $this.val();
            }
        });
        callback(obj);
    }
</script>
<style type="text/css">
    .tab1 {
        border:    1px solid blue;
        width:     95%;
        overflow:  auto;
    }
    .help {
        font-size: small;
    }
</style>
    <div id="adapter-container" style="width: 100%; height: 100%; overflow: hidden">
        <div id="tabs" style="width: 100%; height: 100%; overflow: hidden; display: none;">
            <ul>
                <li><a href="#tabs-1" class="translate">Options</a></li>
                <li><a href="#tabs-2" class="translate">Devices</a></li>
            </ul>
            <div id="tabs-1">
                <table><tr><td><img src="rflink.png"></td><td><h3 class="translate">RFLink adapter settings</h3></td></tr></table>
                <table>
                    <tr class="serial"><td><label for="comName" class="translate">Com port:</label></td><td><select class="value oneWidth" id="comName"></select></td><td></td></tr>
                    <tr class="serial"><td><label for="baudRate" class="translate">Baud rate:</label></td><td><select class="value oneWidth" id="baudRate">
                        <option value="110">110</option>
                        <option value="150">150</option>
                        <option value="300">300</option>
                        <option value="600">600</option>
                        <option value="1200">1200</option>
                        <option value="2400">2400</option>
                        <option value="4800">4800</option>
                        <option value="9600">9600</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="56000">56000</option>
                        <option value="57600">57600</option>
                        <option value="115200">115200</option>
                    </select></td><td></td></tr>
                    <tr><td><label for="connTimeout" class="translate">Connection timeout:</label></td><td><input class="value oneWidth" id="connTimeout" /></td><td class="translate">ms</td></tr>
                    <tr><td><label for="inclusionTimeout" class="translate">Inclusion mode timeout:</label></td><td><input class="value oneWidth" id="inclusionTimeout" /></td><td><span class="translate">inclusion help</span></td></tr>
                    <!--tr><td><label for="autoRepair" class="translate">Timeout for auto re-pair:</label></td><td><input class="value oneWidth" id="autoRepair" /></td><td><span class="translate">re-pair help</span></td></tr-->
                    <tr><td></td><td><button id="enableInclusion" class="translateB">Enable inclusion mode</button></td><td><div id="inclusionState"></div></td></tr>
                </table>
            </div>
            <div id="tabs-2" style="width: 100%; height: calc(100% - 40px); overflow-x: hidden; overflow-y: auto; padding: 0">
                <table style="width: 100%;">
                    <thead>
                    <tr class="ui-widget-header">
                        <td style="width: 100px; text-align: center; white-space: nowrap; white-space: nowrap" class="translate">Brand</td>
                        <td style="width: 70px;  text-align: center; white-space: nowrap" class="translate">Number</td>
                        <td style="width: 50px;  text-align: center; white-space: nowrap" class="translate">Auto re-pair</td>
                        <!--td style="width: 50px;  text-align: center; white-space: nowrap" class="translate">Offset</td>
                        <td style="width: 50px;  text-align: center; white-space: nowrap" class="translate">Factor</td-->
                        <!--td style="width: 50px;  text-align: center" class="translate">ID</td-->
                        <td style="width: 200px; text-align: left;   white-space: nowrap" class="translate">Values</td>
                        <td style="width: 30px;  text-align: center; white-space: nowrap" class="translate">Pair</td>
                        <td style="width: 30px;  text-align: center; white-space: nowrap" class="translate"></td>
                    </tr>
                    </thead>
                    <tbody id="devices">

                    </tbody>
                </table>
            </div>
        </div>
    </div>
</html>